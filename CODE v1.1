#include <Adafruit_NeoPixel.h>

#define PIN_STRIP1 6
#define PIN_STRIP2 7
#define PIN_STRIP3 8
#define PIN_STRIP4 9
#define NUM_PIXELS 24
#define NUM_PIXELS_SMALL 1
#define BUTTON_PIN 4

Adafruit_NeoPixel strip1 = Adafruit_NeoPixel(NUM_PIXELS, PIN_STRIP1, NEO_GRB + NEO_KHZ800);
Adafruit_NeoPixel strip2 = Adafruit_NeoPixel(NUM_PIXELS, PIN_STRIP2, NEO_GRB + NEO_KHZ800);
Adafruit_NeoPixel strip3 = Adafruit_NeoPixel(NUM_PIXELS_SMALL, PIN_STRIP3, NEO_GRB + NEO_KHZ800);
Adafruit_NeoPixel strip4 = Adafruit_NeoPixel(NUM_PIXELS_SMALL, PIN_STRIP4, NEO_GRB + NEO_KHZ800);

int lastButtonState = HIGH;
int colorIndex = 0; // 0 = Static Color, 1 = Outer LEDs Green, 2 = Pulsing Green, 3 = RGB Wheel, 4 = Stars Animation, 5 = Police Animation, 6 = Random Color Blinks, 7 = Running Lights
uint32_t currentColor = strip1.Color(0, 255, 0); // Initial color (Green)

unsigned long previousMillis = 0;
const long interval = 100; // Zeitintervall für die RGB Wheel Animation
unsigned long lastWhiteAnimMillis = 0; // Zeitstempel für die letzte weiße Animation
unsigned long lastPoliceAnimMillis = 0; // Zeitstempel für die letzte Polizei Animation
unsigned long lastPulseMillis = 0; // Zeitstempel für die letzte Pulsation
const long policeInterval = 300; // Intervall für die Polizei-Animation
int wheelPosition = 0; // Position im RGB-Farbkreis
unsigned long lastRunningLightsMillis = 0; // Zeitstempel für die letzte laufende Lichter Animation
const long runningLightsInterval = 100; // Intervall für das Ein- und Ausschalten der LEDs

void setup() {
  Serial.begin(9600); // Initialize serial communication at 9600 bits per second
  strip1.begin();
  strip2.begin();
  strip3.begin();
  strip4.begin();
  strip1.show(); // Initialize all pixels to 'off'
  strip2.show(); // Initialize all pixels to 'off'
  strip3.show(); // Initialize all pixels to 'off'
  strip4.show(); // Initialize all pixels to 'off'

  pinMode(BUTTON_PIN, INPUT_PULLUP);

  // Startup Animation
  startupAnimation();

  // Set initial color
  setAllPixelsColor(currentColor);
}

void loop() {
  unsigned long currentMillis = millis();

  // Read the button state
  int buttonState = digitalRead(BUTTON_PIN);
  if (buttonState == LOW && lastButtonState == HIGH) {
    // Toggle color mode on button press
    colorIndex = (colorIndex + 1) % 8; // Toggle between Static Color (0), Outer LEDs Green (1), Pulsing Green (2), RGB Wheel (3), Stars Animation (4), Police Animation (5), Random Color Blinks (6), Running Lights (7)
    if (colorIndex == 0) {
      currentColor = strip1.Color(0, 255, 0); // Set to Green
      setAllPixelsColor(currentColor);
    }
    Serial.print("Button Pressed. Color Index: ");
    Serial.println(colorIndex);
    delay(200); // Debounce delay
  }
  lastButtonState = buttonState;

  // Update the animation mode
  if (colorIndex == 1) {
    // Outer LEDs Green mode
    setOuterLEDsGreen();
  } else if (colorIndex == 2) {
    // Pulsing Green mode
    if (currentMillis - lastPulseMillis >= 50) {
      lastPulseMillis = currentMillis;
      pulsingGreenAnimation();
    }
  } else if (colorIndex == 3) {
    // Running Lights mode
    if (currentMillis - lastRunningLightsMillis >= runningLightsInterval) {
      lastRunningLightsMillis = currentMillis;
      runningLightsAnimation();
    }


  } else if (colorIndex == 4) {
    // RGB Wheel mode
    if (currentMillis - previousMillis >= interval) {
      previousMillis = currentMillis;
      updateRGBWheel(strip1);
      updateRGBWheel(strip2);
      updateRGBWheelSmall(strip3);
      updateRGBWheelSmall(strip4);
    }




  } else if (colorIndex == 5) {
    
    // Stars Animation mode
    starsAnimation();
  } else if (colorIndex == 6) {

    // Police Animation mode
    if (currentMillis - lastPoliceAnimMillis >= policeInterval) {
      lastPoliceAnimMillis = currentMillis;
      policeAnimation();
    }


  } else if (colorIndex == 7) {

    // Random Color Blinks mode
    randomColorBlinks();
  } else {
    // Static Color mode
    setAllPixelsColor(currentColor);
    if (currentMillis - lastWhiteAnimMillis >= 5000) {
      lastWhiteAnimMillis = currentMillis;
      // Optional: Call whitePixelRacer if you want the white animation
    }
  }
}

void setAllPixelsColor(uint32_t color) {
  // Set NeoPixels color (background color)
  for (int i = 0; i < NUM_PIXELS; i++) {
    strip1.setPixelColor(i, color);
    strip2.setPixelColor(i, color);
  }
  strip3.setPixelColor(0, color);
  strip4.setPixelColor(0, color);

  strip1.show();
  strip2.show();
  strip3.show();
  strip4.show();
}

void setOuterLEDsGreen() {
  // Set LEDs in regular intervals of 5 to green
  strip1.clear();
  strip2.clear();
  strip3.clear();
  strip4.clear();

  for (int i = 0; i < NUM_PIXELS; i += 5) {
    strip1.setPixelColor(i, strip1.Color(0, 255, 0)); // Set every 5th LED to green
    strip2.setPixelColor(i, strip2.Color(0, 255, 0)); // Set every 5th LED to green
  }
  strip3.setPixelColor(0, strip3.Color(0, 255, 0));
  strip4.setPixelColor(0, strip4.Color(0, 255, 0));
  
  strip1.show();
  strip2.show();
  strip3.show();
  strip4.show();
}

void updateRGBWheel(Adafruit_NeoPixel& strip) {
  // Update the color of all pixels in the RGB wheel effect
  for (int i = 0; i < NUM_PIXELS; i++) {
    // Calculate wheel color for the current pixel
    strip.setPixelColor(i, wheel((i + wheelPosition) % 256));
  }
  strip.show();

  // Move the color wheel position
  wheelPosition = (wheelPosition + 1) % 256; // Increment the wheel position
  delay(20); // Delay for color wheel speed
}

void updateRGBWheelSmall(Adafruit_NeoPixel& strip) {
  // Update the color of the single pixel in the RGB wheel effect
  strip.setPixelColor(0, wheel(wheelPosition % 256));
  strip.show();
}

uint32_t wheel(byte pos) {
  // Generate a color wheel effect
  if (pos < 85) {
    return strip1.Color(pos * 3, 255 - pos * 3, 0);
  } else if (pos < 170) {
    pos -= 85;
    return strip1.Color(255 - pos * 3, 0, pos * 3);
  } else {
    pos -= 170;
    return strip1.Color(0, pos * 3, 255 - pos * 3);
  }
}

void startupAnimation() {
  // Define the animation speed
  const int speed = 50; // Speed of the animation (lower is faster)

  // Define green shades for the animation
  uint32_t greenShades[] = {
    strip1.Color(0, 50, 0),    // Dark green
    strip1.Color(0, 100, 0),   // Medium green
    strip1.Color(0, 150, 0),   // Bright green
    strip1.Color(0, 200, 0),   // Very bright green
    strip1.Color(0, 255, 0)    // Full green
  };
  int numShades = sizeof(greenShades) / sizeof(greenShades[0]);

  // Wipe animation with gradient effect (forward)
  for (int i = 0; i < NUM_PIXELS; i++) {
    // Clear all strips
    strip1.clear();
    strip2.clear();
    strip3.clear();
    strip4.clear();

    // Set pixels from start to current position with a green gradient effect
    for (int j = 0; j <= i; j++) {
      uint32_t color = greenShades[j % numShades];
      strip1.setPixelColor(j, color);
      strip2.setPixelColor(j, color);
    }

    // Show the updates
    strip1.show();
    strip2.show();
    strip3.show();
    strip4.show();
    
    // Delay to create the running effect
    delay(speed);
  }

  // End with a full green wipe effect (backward)
  for (int i = NUM_PIXELS - 1; i >= 0; i--) {


    // Set pixels from end to current position with full green
    for (int j = NUM_PIXELS - 1; j >= i; j--) {
      strip1.setPixelColor(j, strip1.Color(0, 255, 0)); // Full green
      strip2.setPixelColor(j, strip1.Color(0, 255, 0)); // Full green
    }

    // Show the updates
    strip1.show();
    strip2.show();
    strip3.show();
    strip4.show();
    
    // Delay to create the running effect
    delay(speed);
  }

  // Keep all LEDs on at the end of the animation
  setAllPixelsColor(strip1.Color(0, 255, 0)); // Full green
}



void policeAnimation() {
  // Police animation with alternating red and blue stripes
  static bool isRed = true; // Alternates between red and blue

  // Set one strip to red and the other to blue
  if (isRed) {
    setStripColor(strip1, strip1.Color(255, 0, 0)); // Red
    setStripColor(strip2, strip2.Color(0, 0, 255)); // Blue
    strip3.setPixelColor(0, strip3.Color(255, 0, 0)); // Red
    strip4.setPixelColor(0, strip4.Color(0, 0, 255)); // Blue
  } else {
    setStripColor(strip1, strip1.Color(0, 0, 255)); // Blue
    setStripColor(strip2, strip2.Color(255, 0, 0)); // Red
    strip3.setPixelColor(0, strip3.Color(0, 0, 255)); // Blue
    strip4.setPixelColor(0, strip4.Color(255, 0, 0)); // Red
  }

  strip1.show();
  strip2.show();
  strip3.show();
  strip4.show();

  // Toggle color for the next frame
  isRed = !isRed;
}

void pulsingGreenAnimation() {
  // Pulsing green animation
  static int brightness = 255;
  static int fadeAmount = -5; // Fade in and out

  // Update brightness
  brightness += fadeAmount;

  // Reverse the direction of the fading at the ends of the fade
  if (brightness <= 0 || brightness >= 255) {
    fadeAmount = -fadeAmount;
  }

  // Set all pixels to green with the current brightness
  setAllPixelsColor(strip1.Color(0, brightness, 0));
}

void starsAnimation() {
  // Stars animation with random LEDs lighting up
  int numStars = 5; // Number of stars

  strip1.clear();
  strip2.clear();
  strip3.clear();
  strip4.clear();

  for (int i = 0; i < numStars; i++) {
    int randomPixel = random(NUM_PIXELS);
    strip1.setPixelColor(randomPixel, strip1.Color(255, 255, 255)); // White star
    strip2.setPixelColor(randomPixel, strip2.Color(255, 255, 255)); // White star
  }
  int randomPixelSmall = random(2); // Randomly choose between the two small strips
  if (randomPixelSmall == 0) {
    strip3.setPixelColor(0, strip3.Color(255, 255, 255)); // White star
  } else {
    strip4.setPixelColor(0, strip4.Color(255, 255, 255)); // White star
  }

  strip1.show();
  strip2.show();
  strip3.show();
  strip4.show();
}

void randomColorBlinks() {
  // Random Color Blinks Animation
  strip1.clear();
  strip2.clear();
  strip3.clear();
  strip4.clear();

  // Randomly set colors for all pixels
  for (int i = 0; i < NUM_PIXELS; i++) {
    uint32_t color = strip1.Color(random(256), random(256), random(256));
    strip1.setPixelColor(i, color);
    strip2.setPixelColor(i, color);
  }

  // Randomly set color for the small strips
  uint32_t colorSmall = strip1.Color(random(256), random(256), random(256));
  strip3.setPixelColor(0, colorSmall);
  strip4.setPixelColor(0, colorSmall);

  strip1.show();
  strip2.show();
  strip3.show();
  strip4.show();

  delay(100); // Delay for the blinking effect
}

void runningLightsAnimation() {
  // Running Lights Animation: LEDs turn on and off in sequence
  static int currentPixel = 0;
  static unsigned long lastUpdateMillis = 0;
  const long interval = 100; // Time between each LED turning on or off

  unsigned long currentMillis = millis();
  
  if (currentMillis - lastUpdateMillis >= interval) {
    lastUpdateMillis = currentMillis;

    // Clear all strips
    strip1.clear();
    strip2.clear();
    strip3.clear();
    strip4.clear();

    // Turn on the current LED
    strip1.setPixelColor(currentPixel, strip1.Color(0, 255, 0)); // White
    strip2.setPixelColor(currentPixel, strip2.Color(0, 255, 0)); // White

    // Turn on the pixel in one of the small strips
    if (currentPixel % 2 == 0) {
      strip3.setPixelColor(0, strip3.Color(0, 255, 0)); // White
    } else {
      strip4.setPixelColor(0, strip4.Color(0, 255, 0)); // White
    }

    // Show the updated strips
    strip1.show();
    strip2.show();
    strip3.show();
    strip4.show();

    // Move to the next pixel
    currentPixel = (currentPixel + 1) % NUM_PIXELS;

    // Optional: delay to see each LED before it turns off
    delay(50);
  }
}

void setStripColor(Adafruit_NeoPixel& strip, uint32_t color) {
  // Set all pixels of the given strip to the specified color
  for (int i = 0; i < strip.numPixels(); i++) {
    strip.setPixelColor(i, color);
  }
}

